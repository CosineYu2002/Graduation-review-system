# 🎓 系統架構圖

## 整體架構

```
┌─────────────────────────────────────────────────────────────┐
│                      使用者介面層                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │            Vue 3 + Quasar Framework                   │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │
│  │  │ 學生資料  │  │ 規則資料  │  │ 審查結果  │          │   │
│  │  │   頁面    │  │   頁面    │  │   頁面    │          │   │
│  │  └──────────┘  └──────────┘  └──────────┘          │   │
│  │                                                       │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │         Axios (HTTP Client)                  │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ HTTP/REST API
                            │ (JSON)
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      API 服務層                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                FastAPI Application                    │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐        │   │
│  │  │  Students │  │   Rules   │  │ Evaluation│        │   │
│  │  │  Router   │  │  Router   │  │  Router   │        │   │
│  │  └───────────┘  └───────────┘  └───────────┘        │   │
│  │                                                       │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │         CORS Middleware                      │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            │
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    業務邏輯層                                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              規則引擎 (Rule Engine)                    │   │
│  │                                                       │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │       Evaluator Registry Pattern            │    │   │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  │    │   │
│  │  │  │ RuleAll  │  │ RuleSet  │  │  其他     │  │    │   │
│  │  │  │Evaluator │  │Evaluator │  │Evaluators│  │    │   │
│  │  │  └──────────┘  └──────────┘  └──────────┘  │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  │                                                       │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │      Factory Pattern (工廠模式)              │    │   │
│  │  │  - StudentFactory                            │    │   │
│  │  │  - RuleFactory                               │    │   │
│  │  │  - CourseFactory                             │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  │                                                       │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │         Utility Functions                    │    │   │
│  │  │  - Course Matching                           │    │   │
│  │  │  - Grade Status Conversion                   │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            │
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    資料存取層                                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              CRUD Operations                          │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │  - StudentCRUD                               │    │   │
│  │  │  - RuleCRUD (待實現)                          │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            │
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    資料存儲層                                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │                JSON File Storage                      │   │
│  │                                                       │   │
│  │  data/                                                │   │
│  │  ├── students/         (學生資料)                      │   │
│  │  │   ├── A1110001.json                               │   │
│  │  │   └── A1110002.json                               │   │
│  │  │                                                    │   │
│  │  ├── rules/            (畢業規則)                      │   │
│  │  │   ├── E2/                                          │   │
│  │  │   │   ├── 110.json                                │   │
│  │  │   │   └── 112.json                                │   │
│  │  │   └── AN/                                          │   │
│  │  │                                                    │   │
│  │  └── departments_info.json  (系所資訊)                │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 請求流程圖

### 1. 取得學生列表

```
┌─────────┐                                    ┌──────────┐
│ Browser │                                    │ Backend  │
└────┬────┘                                    └────┬─────┘
     │                                              │
     │  GET /api/students/                         │
     │─────────────────────────────────────────────>│
     │                                              │
     │                     ┌──────────────────────┐ │
     │                     │  StudentCRUD         │ │
     │                     │  .get_all_students() │ │
     │                     └──────────┬───────────┘ │
     │                                │             │
     │                     ┌──────────▼───────────┐ │
     │                     │ 讀取 JSON 檔案        │ │
     │                     │ data/students/*.json │ │
     │                     └──────────┬───────────┘ │
     │                                │             │
     │  200 OK                        │             │
     │  { success: true, data: [...] }             │
     │<─────────────────────────────────────────────│
     │                                              │
```

### 2. 上傳 Excel 檔案

```
┌─────────┐                                    ┌──────────┐
│ Browser │                                    │ Backend  │
└────┬────┘                                    └────┬─────┘
     │                                              │
     │  POST /api/students/upload-excel            │
     │  FormData: { file, major }                  │
     │─────────────────────────────────────────────>│
     │                                              │
     │                     ┌──────────────────────┐ │
     │                     │ 驗證檔案格式         │ │
     │                     │ (.xlsx, <10MB)      │ │
     │                     └──────────┬───────────┘ │
     │                                │             │
     │                     ┌──────────▼───────────┐ │
     │                     │ StudentFactory       │ │
     │                     │ .load_from_excel()   │ │
     │                     └──────────┬───────────┘ │
     │                                │             │
     │                     ┌──────────▼───────────┐ │
     │                     │ 解析 Excel           │ │
     │                     │ 建立 Student 物件     │ │
     │                     └──────────┬───────────┘ │
     │                                │             │
     │                     ┌──────────▼───────────┐ │
     │                     │ 儲存 JSON 檔案        │ │
     │                     │ data/students/       │ │
     │                     └──────────┬───────────┘ │
     │                                │             │
     │  200 OK                        │             │
     │  { success: true, data: [...] }             │
     │<─────────────────────────────────────────────│
     │                                              │
```

### 3. 執行畢業審查

```
┌─────────┐                                    ┌──────────┐
│   CLI   │                                    │  Engine  │
└────┬────┘                                    └────┬─────┘
     │                                              │
     │  evaluate(student, rule)                    │
     │─────────────────────────────────────────────>│
     │                                              │
     │                     ┌──────────────────────┐ │
     │                     │ EvaluatorRegistry    │ │
     │                     │ .create_evaluator()  │ │
     │                     └──────────┬───────────┘ │
     │                                │             │
     │                     ┌──────────▼───────────┐ │
     │                     │ RuleSetEvaluator     │ │
     │                     │ .evaluate()          │ │
     │                     └──────────┬───────────┘ │
     │                                │             │
     │                     ┌──────────▼───────────┐ │
     │                     │ 遞迴評估子規則        │ │
     │                     │ - RuleAll            │ │
     │                     │ - RuleSet            │ │
     │                     └──────────┬───────────┘ │
     │                                │             │
     │                     ┌──────────▼───────────┐ │
     │                     │ UtilFunctions        │ │
     │                     │ .match_criteria()    │ │
     │                     └──────────┬───────────┘ │
     │                                │             │
     │                     ┌──────────▼───────────┐ │
     │                     │ 計算學分、檢查條件    │ │
     │                     │ 標記課程為已認證     │ │
     │                     └──────────┬───────────┘ │
     │                                │             │
     │  Result Object                 │             │
     │  { is_valid, earned_credits }                │
     │<─────────────────────────────────────────────│
     │                                              │
```

## 資料模型關係

```
┌──────────────┐
│   Student    │
├──────────────┤
│ id           │
│ name         │
│ major        │
│ courses []   │───┐
└──────────────┘   │
                   │ 1:N
                   │
                   ↓
            ┌──────────────────┐
            │  StudentCourse   │
            ├──────────────────┤
            │ course_name      │
            │ course_codes []  │
            │ credit           │
            │ grade            │
            │ recognized       │
            │ ...              │
            └──────────────────┘


┌──────────────┐
│   RuleSet    │
├──────────────┤
│ name         │
│ description  │
│ sub_rules [] │───┐
│ requirement  │   │ 1:N
└──────────────┘   │
                   │
                   ↓
            ┌──────────────┐
            │    Rule      │
            │  (Abstract)  │
            └──────┬───────┘
                   │
          ┌────────┼────────┐
          │                 │
    ┌─────▼─────┐    ┌─────▼─────┐
    │  RuleAll  │    │  RuleSet  │
    ├───────────┤    ├───────────┤
    │ course_   │    │ sub_rules │
    │   list    │    │ sub_rule_ │
    │ criteria  │    │   logic   │
    │ require-  │    │ require-  │
    │   ment    │    │   ment    │
    └───────────┘    └───────────┘
```

## 技術棧

```
┌─────────────────────────────────────────────────────────────┐
│                         前端                                  │
├─────────────────────────────────────────────────────────────┤
│ • Vue 3 (Composition API)                                    │
│ • Quasar Framework v2 (Material Design)                      │
│ • Vue Router 4                                               │
│ • Pinia (狀態管理)                                            │
│ • Axios (HTTP Client)                                        │
│ • Vite (構建工具)                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                         後端                                  │
├─────────────────────────────────────────────────────────────┤
│ • Python 3.10+                                               │
│ • FastAPI 0.118                                              │
│ • Pydantic v2 (資料驗證)                                      │
│ • Uvicorn (ASGI Server)                                      │
│ • Pandas (Excel 處理)                                         │
│ • BeautifulSoup4 (網頁爬蟲)                                   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                       開發工具                                │
├─────────────────────────────────────────────────────────────┤
│ • ESLint + Prettier (程式碼格式化)                            │
│ • Swagger UI (API 文檔)                                      │
│ • Git (版本控制)                                              │
│ • GitHub Copilot (AI 協作)                                   │
└─────────────────────────────────────────────────────────────┘
```

## 核心設計模式

### 1. 工廠模式 (Factory Pattern)

```python
# 用於創建領域物件
StudentFactory.from_json_file(path)
RuleFactory.from_json_string(json)
CourseFactory.from_excel_row(row)
```

### 2. 註冊器模式 (Registry Pattern)

```python
# 動態註冊評估器
@register_evaluator("rule_all")
class RuleAllEvaluator:
    def evaluate(self, rule, courses) -> Result:
        ...
```

### 3. 策略模式 (Strategy Pattern)

```python
# 不同規則類型使用不同評估策略
evaluator = registry.create_evaluator(rule.rule_type)
result = evaluator.evaluate(rule, courses)
```

### 4. 組合模式 (Composite Pattern)

```python
# RuleSet 可以包含其他 Rule
RuleSet
  ├── RuleAll
  ├── RuleSet
  │   ├── RuleAll
  │   └── RuleAll
  └── RuleAll
```

---

**建立日期：** 2025-10-17  
**版本：** 1.0.0
